---
title: "DCSMex_5_draft"
author: "Nico Binder"
date: "2023-01-21"
output: html_document
---
libs
```{r}
#load libs
# load libs
library(RPostgreSQL)
library(getPass)
# library(sf)

```

getPass function
```{r}
# create the getPass function for easy connection
pw_fun <- function () {
  if (Sys.getenv('POSTGRES_PASSWORD') == ""){
    return(getPass('Provide the password: '))
  } else {
    return(Sys.getenv('POSTGRES_PASSWORD'))
  }
}
```

connect to D
```{r}
# connect to db
# declare driver (I guess you could say picking the correct dialect according to the DB)
DB_diver <- dbDriver('PostgreSQL')
# connect using RPostgreSQL::dbConnect and place getPass function in place of PW
# pass DB credentials as arguments
DB_connection <- dbConnect(DB_diver, host='hydenv.hydrocode.de', port=5432, user='hydenv', 
                 password=pw_fun(), dbname='hydenv')
# using underscore object names and spelling them out makes it easier to work through this

```

look at tables
```{r}
# admire all the tables
dbListTables(DB_connection)
```

pull meta table
```{r}
# get meta table 
HOBO_MTab <- dbReadTable(DB_connection, 'metadata')
# is sf:: wasn't loaded this would give a warning for the geometry data in col4
# it still gives that error... 
# TODO find out why geometry warning

```

5.1 GENERATE OVERVIEW
filter 2023 HOBOS from meta table using sql
first find term abbreviation in table terms
```{sql connection=DB_connection}
SELECT * FROM terms

```

so it's
id: 13	short:WT22	full_name:Winterterm 2022/2023

what are the column names of the meta table
```{sql connection=DB_connection}
SELECT * FROM metadata 
```

so the way to find the year is through the attribute term_id

```{sql connection=DB_connection}
SELECT * FROM metadata WHERE term_id=13
```

this looks good
I guess that was the whole first question??
bring int Rstudio object env
```{sql connection=DB_connection}
create temporary view temperature as
select meta_id, tstamp, value as temperature from raw_data where variable_id=1

select * from temperature limit 5
```





next up: 5.2 CALCULATE INDICES

first pull own HOBO from hrly corrected data
i guess that's temp_data
```{sql connection=DB_connection}
SELECT * FROM raw_data WHERE meta_id = 157
```


TESTTEST
i guess that's temp_data
```{sql connection=DB_connection}
SELECT * FROM data WHERE meta_id = 157
```


```{sql connection=DB_connection}
SELECT * FROM temp_data LIMIT 50
```

```{sql connection=DB_connection}
select * from data LIMIT 50


```


```{sql connection=DB_connection}
create temporary view temperature2 as
select meta_id, tstamp, value as temperature from raw_data where variable_id=1
```

```{sql connection=DB_connection}
view temperature2

```



close connection
```{r}
dbDisconnect(DB_connection)
```





